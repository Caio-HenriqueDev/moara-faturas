<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moara Gest√£o - Sistema de Gest√£o de Faturas</title>
    <meta name="description" content="Plataforma completa para gest√£o de faturas de energia e clientes">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Moara Gest√£o">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#10b981">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    
    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-solar-panel"></i>
                <span>Moara Gest√£o</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item active">
                    <a href="#dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#clientes">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#faturas">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Faturas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#pagamentos">
                        <i class="fas fa-credit-card"></i>
                        <span>Pagamentos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#relatorios">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relat√≥rios</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="page-title">Dashboard</h1>
            </div>
            
            <div class="header-right">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar...">
                </div>
                
                <!-- Seletor de Ambiente -->
                <div class="environment-selector">
                    <select id="env-selector" onchange="switchEnvironment(this.value)">
                        <option value="local">üè† Local</option>
                        <option value="vercel">‚òÅÔ∏è Vercel</option>
                        <option value="vercel2">‚òÅÔ∏è Vercel 2</option>
                    </select>
                </div>
                
                <div class="user-menu">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user-name">Admin</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboard-content">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total de Clientes</h3>
                        <p class="stat-number" id="total-clientes">0</p>
                        <span class="stat-change positive">+0% este m√™s</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Faturas Pendentes</h3>
                        <p class="stat-number" id="faturas-pendentes">0</p>
                        <span class="stat-change negative">0 pendentes</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Receita Total</h3>
                        <p class="stat-number" id="receita-total">R$ 0,00</p>
                        <span class="stat-change positive">+0% este m√™s</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Pagamentos Confirmados</h3>
                        <p class="stat-number" id="pagamentos-confirmados">0</p>
                        <span class="stat-change positive">100% em dia</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="processar-emails">
                    <i class="fas fa-envelope"></i>
                    Processar Novos E-mails
                </button>
                
                <button class="btn btn-secondary" id="nova-fatura">
                    <i class="fas fa-plus"></i>
                    Nova Fatura
                </button>
                
                <button class="btn btn-success" id="novo-cliente">
                    <i class="fas fa-user-plus"></i>
                    Novo Cliente
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Faturas Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2>Faturas Recentes</h2>
                        <button class="btn btn-outline" id="ver-todas-faturas">
                            Ver Todas
                        </button>
                    </div>
                    
                    <div class="faturas-container" id="faturas-container">
                        <div id="loading" class="loading-message">
                            <i class="fas fa-spinner fa-spin"></i>
                            Carregando faturas...
                        </div>
                        <div id="no-faturas" class="no-data" style="display: none;">
                            <i class="fas fa-inbox"></i>
                            <h3>Nenhuma fatura encontrada</h3>
                            <p>Clique em "Processar Novos E-mails" para buscar faturas automaticamente.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clientes Content (Hidden by default) -->
        <div class="clientes-content" id="clientes-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2>Gest√£o de Clientes</h2>
                    <button class="btn btn-primary" id="adicionar-cliente">
                        <i class="fas fa-plus"></i>
                        Adicionar Cliente
                    </button>
                </div>
                
                <div class="clientes-grid" id="clientes-grid">
                    <!-- Clientes ser√£o carregados aqui -->
                </div>
            </div>
        </div>

        <!-- Faturas Content (Hidden by default) -->
        <div class="faturas-content" id="faturas-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2>Gest√£o de Faturas</h2>
                    <div class="filters">
                        <input type="text" id="search-filter" placeholder="Buscar por cliente ou instala√ß√£o...">
                        <select id="status-filter">
                            <option value="">Todos os Status</option>
                            <option value="pendente">Pendentes</option>
                            <option value="pago">Pagas</option>
                        </select>
                        <input type="date" id="date-filter">
                        <button class="btn btn-primary" id="limpar-filtros">
                            <i class="fas fa-times"></i>
                            Limpar
                        </button>
                    </div>
                </div>
                
                <div class="faturas-table-container">
                    <table class="faturas-table" id="faturas-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Instala√ß√£o</th>
                                <th>M√™s Ref.</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="faturas-table-body">
                            <!-- Faturas ser√£o carregadas aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagamentos Content (Hidden by default) -->
        <div class="pagamentos-content" id="pagamentos-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2>Hist√≥rico de Pagamentos</h2>
                </div>
                
                <div class="pagamentos-grid" id="pagamentos-grid">
                    <!-- Pagamentos ser√£o carregados aqui -->
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Content (Hidden by default) -->
        <div class="relatorios-content" id="relatorios-content" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h2>Relat√≥rios e Analytics</h2>
                </div>
                
                <div class="relatorios-grid">
                    <div class="relatorio-card">
                        <h3>Relat√≥rio de Faturas</h3>
                        <div class="relatorio-content">
                            <canvas id="faturas-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="relatorio-card">
                        <h3>Receita Mensal</h3>
                        <div class="relatorio-content">
                            <canvas id="receita-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Nova Fatura -->
    <div class="modal" id="modal-nova-fatura">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nova Fatura</h3>
                <button class="modal-close" id="close-nova-fatura">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-nova-fatura" class="modal-form">
                <div class="form-group">
                    <label for="nome-cliente">Nome do Cliente *</label>
                    <input type="text" id="nome-cliente" name="nome_cliente" required>
                </div>
                
                <div class="form-group">
                    <label for="documento-cliente">CPF/CNPJ *</label>
                    <input type="text" id="documento-cliente" name="documento_cliente" required>
                </div>
                
                <div class="form-group">
                    <label for="email-cliente">Email</label>
                    <input type="email" id="email-cliente" name="email_cliente">
                </div>
                
                <div class="form-group">
                    <label for="numero-instalacao">N√∫mero de Instala√ß√£o *</label>
                    <input type="text" id="numero-instalacao" name="numero_instalacao" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="valor-total">Valor Total *</label>
                        <input type="number" id="valor-total" name="valor_total" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mes-referencia">M√™s de Refer√™ncia *</label>
                        <input type="month" id="mes-referencia" name="mes_referencia" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="data-vencimento">Data de Vencimento *</label>
                    <input type="date" id="data-vencimento" name="data_vencimento" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelar-nova-fatura">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Salvar Fatura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Novo Cliente -->
    <div class="modal" id="modal-novo-cliente">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Cliente</h3>
                <button class="modal-close" id="close-novo-cliente">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-novo-cliente" class="modal-form">
                <div class="form-group">
                    <label for="cliente-nome">Nome Completo *</label>
                    <input type="text" id="cliente-nome" name="nome" required>
                </div>
                
                <div class="form-group">
                    <label for="cliente-documento">CPF/CNPJ *</label>
                    <input type="text" id="cliente-documento" name="documento" required>
                </div>
                
                <div class="form-group">
                    <label for="cliente-email">Email *</label>
                    <input type="email" id="cliente-email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="cliente-telefone">Telefone</label>
                    <input type="tel" id="cliente-telefone" name="telefone">
                </div>
                
                <div class="form-group">
                    <label for="cliente-endereco">Endere√ßo</label>
                    <textarea id="cliente-endereco" name="endereco" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelar-novo-cliente">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i>
                        Cadastrar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes da Fatura -->
    <div class="modal" id="modal-detalhes-fatura">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes da Fatura</h3>
                <button class="modal-close" id="close-detalhes-fatura">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detalhes-fatura-content">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" id="fechar-detalhes">Fechar</button>
                <button class="btn btn-primary" id="pagar-fatura-modal" style="display: none;">
                    <i class="fas fa-credit-card"></i>
                    Pagar Fatura
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal" id="modal-confirmacao">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmacao-titulo">Confirma√ß√£o</h3>
                <button class="modal-close" id="close-confirmacao">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmacao-mensagem">Tem certeza que deseja continuar?</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelar-acao">Cancelar</button>
                <button class="btn btn-primary" id="confirmar-acao">Confirmar</button>
            </div>
        </div>
    </div>
    </main>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Stripe para pagamentos -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Configura√ß√£o da aplica√ß√£o -->
    <script src="./config.js"></script>
    <script src="./app.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                        
                        // Verificar se h√° atualiza√ß√µes
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nova vers√£o dispon√≠vel
                                    if (confirm('Nova vers√£o dispon√≠vel! Deseja atualizar?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Instalar PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar bot√£o de instala√ß√£o
            showInstallButton();
        });
        
        function showInstallButton() {
            // Criar bot√£o de instala√ß√£o se n√£o existir
            if (!document.getElementById('install-pwa-btn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'install-pwa-btn';
                installBtn.className = 'btn btn-primary install-pwa-btn';
                installBtn.innerHTML = '<i class="fas fa-download"></i> Instalar App';
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    padding: 12px 24px;
                    border-radius: 25px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                `;
                
                installBtn.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usu√°rio aceitou instala√ß√£o');
                        }
                        deferredPrompt = null;
                        installBtn.remove();
                    });
                });
                
                document.body.appendChild(installBtn);
            }
        }
        
        // CSS para anima√ß√£o do bot√£o
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>